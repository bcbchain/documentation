# 库

## 1. 创建库

下面我们开始创建库。

用 `GoLand` 打开刚刚创建的 `GoLand Project`，然后通过 BCBChain 智能合约开发插件创建智能合约，以下为执行路径：

```
CopyGoLand左边栏 Project 浏览器
    >> 在 src/contract 目录上点击鼠标右键出现菜单
        >> BCB Smart Contract
            >> New...
                >> 输入 Name             			#banklib
                >> 输入 Type             			 #BankLib
                >> 输入 ContractType		#Library
                >> 输入 Version          			#1.0
                >> 输入 OrganizationName #DAO
                >> 计算 Organization     #orgE37w7wxhZwaox1fhndt5Czm8WnLBrh6db - DAO
                >> 输入 Author           #alice
                >> OK
```

智能合约创建成功，将会自动生成框架代码，文件路径如下：

```
Copysrc/contract/banklib/v1.0/banklib/banklib.go
```

库初始代码如下：

```
package banklib

import (
	"blockchain/smcsdk/sdk"
)

//banklib This is struct of contract
//@:library:banklib
//@:version:1.0
//@:organization:orgE37w7wxhZwaox1fhndt5Czm8WnLBrh6db
//@:author:e5b95784049c3b8669aa58ba08abd9f54281df8905dd3af24bf795b0103f9ec7
type BankLib struct {
	sdk sdk.ISmartContract

    //This is a sample field which is to store in db
    //@:public:store
    sampleStore string

}

//SampleFunction This is a sample function
//@:public:function:gas[500]
func (m *Mydonation) SampleMethod() {

}
```

## 2. 代码示例

### 2.1 库代码

库的编写流程与智能合约的编写流程是一致的,可参考智能合约的开发

下面我们一个简单的库合约作为示例

该库为一个银行合约的库,提供了2个公用的库方法`SetManager`以及`SetSigner`,可用于不同的银行智能合约调用

```go
package banklib

import (
	"blockchain/smcsdk/sdk"
	"blockchain/smcsdk/sdk/types"

)

//banklib This is struct of contract
//@:library:banklib
//@:version:1.0
//@:organization:orgE37w7wxhZwaox1fhndt5Czm8WnLBrh6db
//@:author:5e8339cb1a5cce65602fd4f57e115905348f7e83bcbe38dd77694dbe1f8903c9
type BankLib struct {
	sdk sdk.ILibrary

	//@:public:store
	manager types.Address
    
    //@:public:store
	signer types.PubKey

}

//@:public:receipt
type receipt interface {
	emitSetManager(manager types.Address)
	emitSetSigner(signer types.PubKey)
}

//@:public:function:gas[-1]
func (bl *BankLib) SetManager(manager types.Address) {
	sdk.RequireOwner()

	sdk.RequireAddress(manager)

	bl._setManager(manager)

	bl.emitSetManager(manager)
}

//@:public:function:gas[-1]
func (c *BankLib) SetSigner(pubKey types.PubKey) {
		bl.RequireManager()

	sdk.Require(len(pubKey) == PUBKEYLEN,
		types.ErrInvalidParameter, "Invalid pubkey.")

	bl._setSigner(pubKey)

	bl.emitSetSigner(pubKey)
}

```



### 2.2 合约代码

BeiJingBank 智能合约调用库部分的代码如下

```go
package beijingbank

import (
	"blockchain/smcsdk/sdk"
	"blockchain/smcsdk/sdk/types"
)

//BeiJingBank This is struct of contract
//@:contract:BeiJingBank
//@:version:2.0
//@:organization:orgE37w7wxhZwaox1fhndt5Czm8WnLBrh6db
//@:author:5e8339cb1a5cce65602fd4f57e115905348f7e83bcbe38dd77694dbe1f8903c9
type BeiJingBank struct {
	sdk sdk.ISmartContract

	//@:public:store
	manager types.Address

	//@:public:store
	signer  types.PubKey

}

//@:import:control
type lib interface {
	SetManager(types.Address)
	SetSigner(types.PubKey)
}

//@:constructor
func (bjb *BeiJingBank) InitChain() {
}

//@:public:method:gas[-1]
func (bjb *BeiJingBank) SetManager(manager types.Address) {
	bjb.banklib().SetManager(manager)
}

//@:public:method:gas[-1]
func (bjb *BeiJingBank) SetSigner(pubKey types.PubKey) {
	bjb.banklib().SetSigner(pubKey)
}
```



## 2. 库规范检查

下面的执行路径可以检查上面完成的库代码是否符合 BCBChain 库规范：

```
GoLand左边栏 Project 浏览器
	>> 在 src/contract/banklib/v1.0/banklib 目录上点击鼠标右键出现菜单
		>> BCB Smart Contract
			>> Check
```



## 3. 代码补全

### 3.1库

到现在为止，我们已经完成了库代码，但这个库代码不能在 ```GoLand IDE``` 中直接运行，需要使用插件提供的代码生成功能补全代码以后才能在本地运行，下面是补全代码的执行路径：

```
GoLand左边栏 Project 浏览器
	>> 在 src/contract/banklib/v1.0/banklib 目录上点击鼠标右键出现菜单
		>> BCB Smart Contrat
			>> Generate Code
```

补全代码执行以后，在合约代码目录将会自动生成如下代码文件：

```
//以下文件每次自动生成代码都会将原来的内容覆盖，请不要修改这些代码文件
banklib_autogen_store.go			//自动补全的状态数据库访问代码
banklib_autogen_receipt.go		//自动补全的收据发送代码
banklib_autogen_sdk.go			//自动补全的杂项代码
banklib_wrap_test.go				//自动补全的单元测试基础代码

//以下文件为单元测试代码，需要程序员完成对各个方法的单元测试，下次自动生成代码时不会自动修改其中内容
banklib_case_setManager_test.go	//自动补全的单元测试代码 - 针对 SetManager 方法进行单元测试
banklib_case_setSigner_test.go	//自动补全的单元测试代码 - 针对 SetSigner 方法进行单元测试
```



### 3.2 合约

合约代码的补全操作与库的一致:

```
GoLand左边栏 Project 浏览器
	>> 在 src/contract/BeiJingBank/v1.0/BeiJingBank 目录上点击鼠标右键出现菜单
		>> BCB Smart Contrat
			>> Generate Code
```

补全代码执行后,在合约代码目录将会自动生成如下代码文件:

```
//以下文件每次自动生成代码都会将原来的内容覆盖，请不要修改这些代码文件
beijingbank_autogen_store.go						  //自动补全的状态数据库访问代码
beijingbank_autogen_receipt.go					    //自动补全的收据发送代码
beijingbank_autogen_sdk.go							   //自动补全的杂项代码
beijingbank_wrap_test.go								   //自动补全的单元测试基础代码
beijingbank_autogen_import_banklib.go   //自动补全的库调用的相关辅助代码

//以下文件为单元测试代码，需要程序员完成对各个方法的单元测试，下次自动生成代码时不会自动修改其中内容
beijingbank_case_setManager_test.go	//自动补全的单元测试代码 - 针对 SetManager 方法进行单元测试
beijingbank_case_setSigner_test.go	//自动补全的单元测试代码 - 针对 SetSigner 方法进行单元测试
```



这里主要对`beijingbank_autogen_import_banklib.go`代码作说明,其余部分与正常的合约代码生成的内容一致:

```go
func (intfc *InterfaceStub) SetManager(manager types.Address) {

	methodID := "e463fdb2" // prototype: SetManager(types.Address)
	oldSmc := intfc.stub.GetSdk()

	contract := oldSmc.Helper().ContractHelper().ContractOfName(importContractName)
	sdk.Require(contract != nil, types.ErrExpireContract, "")

	newSmc := sdkhelper.OriginNewMessage(oldSmc, oldSmc.Message().Contract(), methodID, intfc.receipts)

	var rn interface{}
	rn = SetManagerParam{
		manager:manager,
	}

	var response types3.Response
	gls.Mgr.SetValues(gls.Values{gls.SDKKey: newSmc}, func() {
		response = intfc.stub.Invoke(methodID, rn)
	})
	if response.Code != types.CodeOK {
		panic(response.Log)
	}
	oldmsg := oldSmc.Message()
	oldmsg.(*object.Message).AppendOutput(intfc.stub.GetSdk().Message().(*object.Message).OutputReceipts())
	intfc.receipts = nil
}

注: 
1. 库调用中,sdk的相关设置依旧是原合约的设置
2. newSmc所用的合约对象为原合约的合约对象
```

